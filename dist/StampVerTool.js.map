{"version":3,"sources":["../src/StampVerTool.js"],"names":["StampVerTool","constructor","log","run","bind","findVersionFile","dir","process","cwd","length","filename","path","join","fs","existsSync","substring","lastIndexOf","getFullDate","now","year","month","date","getJDate","startYear","toString","replaceTags","str","tags","tagPrefix","tagSuffix","i","tagEnd","tagStart","key","tag","argv","options","string","boolean","alias","u","s","default","increment","args","help","info","version","fullVersion","versionFn","existSync","error","resolve","data","json5","util","promisify","readFile","encoding","JSON5","parse","message","tz","warning","newMajorMinorPatch","build","major","minor","patch","sequence","buildFormat","revision","Object","entries","forEach","arr","versionDirname","dirname","update","filenames","match","fullFilename","fileType","fileTypes","glob","dot","write","writeFile","updates","content","found","replace","search","XRegExp","name","stringify"],"mappings":"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","sourcesContent":["import parseArgs from \"minimist\"\nimport fs from \"fs\"\nimport path from \"path\"\nimport JSON5 from \"json5\"\nimport { fullVersion } from \"./version\"\nimport XRegExp from \"xregexp\"\nimport minimatch from \"minimatch\"\nimport util from \"util\"\nimport moment from \"moment-timezone\"\n\nexport class StampVerTool {\n  constructor(log) {\n    this.log = log\n    this.run = this.run.bind(this)\n  }\n\n  findVersionFile() {\n    let dir = process.cwd()\n\n    while (dir.length !== 0) {\n      const filename = path.join(dir, \"version.json5\")\n\n      if (fs.existsSync(filename)) {\n        return filename\n      } else {\n        dir = dir.substring(0, dir.lastIndexOf(\"/\"))\n      }\n    }\n\n    return null\n  }\n\n  static getFullDate(now) {\n    return now.year() * 10000 + (now.month() + 1) * 100 + now.date()\n  }\n\n  static getJDate(now, startYear) {\n    return (\n      (now.year() - startYear + 1) * 10000 +\n      now.month() * 100 +\n      now.date()\n    ).toString()\n  }\n\n  static replaceTags(str, tags) {\n    const tagPrefix = \"${\"\n    const tagSuffix = \"}\"\n\n    for (let i = str.length - 1; i != -1; ) {\n      const tagEnd = str.lastIndexOf(tagSuffix, i)\n\n      if (tagEnd <= 0) {\n        break\n      }\n\n      const tagStart = str.lastIndexOf(tagPrefix, tagEnd - 1)\n\n      if (tagStart < 0) {\n        break\n      }\n\n      const key = str.substring(tagStart + tagPrefix.length, tagEnd)\n      const tag = tags[key]\n\n      if (typeof tag !== \"undefined\") {\n        str =\n          str.substring(0, tagStart) +\n          tag +\n          str.substring(tagEnd + tagSuffix.length)\n      }\n\n      i = tagStart - 1\n    }\n    return str\n  }\n\n  async run(argv) {\n    const options = {\n      string: [\"increment\"],\n      boolean: [\"help\", \"version\", \"update\", \"sequence\"],\n      alias: {\n        u: \"update\",\n        i: \"increment\",\n        s: \"sequence\",\n      },\n      default: {\n        increment: \"none\",\n      },\n    }\n    let args = parseArgs(argv, options)\n\n    if (args.help) {\n      this.log.info(`\nVersion stamper\n\nUsage: stampver [-u] [<version-file>]\n\n<version-file> defaults to 'version.json5'.\n\nWill increment the build and/or revision number and search/replace all other version\nrelated information in a list of files.\n\nSearches for a 'version.json5' file in the current and parent directories and uses\nthat as the root directory for project files. See https://github.com/jlyonsmith/stampver\nfor the format of the version.json5 file.\n\n-u, --update            Actually do the file updates. Defaults to just reporting changes.\n-i, --increment <part>  Also increment one of major, minor or patch parts of version.\n                        Defaults to none.  Updating major will reset minor and patch to zero,\n                        updating minor will just reset patch.\n-s, --sequence          Increment the sequence number. Just a monotonically increasing\n                        number.\n--help                  Displays this help\n--version               Displays tool version\n`)\n      return 0\n    }\n\n    if (args.version) {\n      this.log.info(`v${fullVersion}`)\n      return 0\n    }\n\n    let versionFn = args[\"_\"].length > 0 ? args[\"_\"][0] : null\n\n    if (versionFn && !fs.existSync(versionFn)) {\n      this.log.error(`Unable to find file '${versionFn}'`)\n      return -1\n    }\n\n    versionFn = this.findVersionFile()\n\n    if (!versionFn) {\n      this.log.error(\n        `Unable to find version.json5 file in this or parent directories`\n      )\n      return -1\n    }\n\n    versionFn = path.resolve(versionFn)\n\n    if (this.versionFn && !fs.existsSync(this.versionFn)) {\n      this.log.error(`File '${this.versionFn}' does not exist`)\n      return -1\n    }\n\n    this.log.info(`Version file is '${versionFn}''`)\n\n    let data = null\n    try {\n      const json5 = await util.promisify(fs.readFile)(versionFn, {\n        encoding: \"utf8\",\n      })\n      data = JSON5.parse(json5)\n    } catch (error) {\n      this.log.error(`'${versionFn}': ${error.message}`)\n      return -1\n    }\n\n    let now = null\n    if (data.tags.tz) {\n      now = moment().tz(data.tags.tz)\n    } else {\n      this.log.warning(\"No 'tz' value set - using local time zone\")\n      now = moment()\n    }\n    const newMajorMinorPatch = args.increment !== \"none\"\n    let build\n\n    if (newMajorMinorPatch) {\n      switch (args.increment) {\n        case \"major\":\n          data.tags.major += 1\n          data.tags.minor = 0\n          data.tags.patch = 0\n          break\n        case \"minor\":\n          data.tags.minor += 1\n          data.tags.patch = 0\n          break\n        case \"patch\":\n          data.tags.patch += 1\n          break\n      }\n    }\n\n    if (args.sequence) {\n      let sequence = data.tags.sequence || 0\n\n      sequence += 1\n      data.tags.sequence = sequence\n    }\n\n    switch (data.buildFormat) {\n      case \"jdate\":\n        build = StampVerTool.getJDate(now, data.startYear)\n\n        if (newMajorMinorPatch || data.tags.build !== build) {\n          data.tags.build = build\n          data.tags.revision = 0\n        } else {\n          data.tags.revision += 1\n        }\n        break\n\n      case \"full\":\n        build = StampVerTool.getFullDate(now)\n\n        if (newMajorMinorPatch || data.tags.build !== build) {\n          data.tags.build = build\n          data.tags.revision = 0\n        } else {\n          data.tags.revision += 1\n        }\n        break\n\n      case \"incr\":\n        if (newMajorMinorPatch) {\n          data.tags.build = 0\n        } else {\n          data.tags.build += 1\n        }\n        data.tags = revision = 0\n        break\n\n      default:\n        this.log.error(\n          `Unknown build number format ${\n            data.buildFormat\n          }. Must be 'jdate', 'full' or 'incr'`\n        )\n        return -1\n    }\n\n    this.log.info(\"Tags are:\")\n\n    Object.entries(data.tags).forEach((arr) => {\n      this.log.info(`  ${arr[0]}='${arr[1]}'`)\n    })\n\n    const versionDirname = path.dirname(versionFn)\n\n    this.log.info(`${args.update ? \"Updating\" : \"Checking\"} file list:`)\n\n    for (let filename of data.filenames) {\n      let match = false\n      const fullFilename = path.resolve(path.join(versionDirname, filename))\n\n      this.log.info(`  ${fullFilename}`)\n\n      for (let fileType of data.fileTypes) {\n        if (!minimatch(filename, fileType.glob, { dot: true })) {\n          continue\n        }\n\n        match = true\n\n        if (fileType.write) {\n          const dirname = path.dirname(fullFilename)\n\n          if (!fs.existsSync(dirname)) {\n            this.log.error(`Directory '${dirname}' does not exist`)\n            return -1\n          }\n\n          if (args.update) {\n            await util.promisify(fs.writeFile)(\n              filename,\n              StampVerTool.replaceTags(fileType.write, data.tags)\n            )\n          }\n        } else {\n          if (fs.existsSync(fullFilename)) {\n            const updates = fileType.updates || [fileType.update]\n            let content = await util.promisify(fs.readFile)(fullFilename, {\n              encoding: \"utf8\",\n            })\n\n            updates.forEach((update) => {\n              let found = false\n              let replace = StampVerTool.replaceTags(update.replace, data.tags)\n              let search = new XRegExp(update.search, \"m\")\n              content = XRegExp.replace(\n                content,\n                search,\n                (match) => {\n                  found = true\n                  return StampVerTool.replaceTags(replace, match)\n                },\n                \"one\"\n              )\n\n              if (!found) {\n                this.log.warning(\n                  `File type '${fileType.name}' update '${\n                    update.search\n                  }' did not match anything`\n                )\n              }\n            })\n\n            if (args.update) {\n              await util.promisify(fs.writeFile)(fullFilename, content)\n            }\n          } else {\n            this.log.error(`File '${fullFilename}' does not exist to update`)\n            return -1\n          }\n        }\n\n        if (match) {\n          break\n        }\n      }\n\n      if (!match) {\n        this.log.error(`File '${fullFilename}' has no matching file type`)\n        continue\n      }\n    }\n\n    if (args.update) {\n      await util.promisify(fs.writeFile)(\n        versionFn,\n        JSON5.stringify(data, null, \"  \")\n      )\n    }\n\n    return 0\n  }\n}\n"],"file":"StampVerTool.js"}